---
phase: 01-electron-foundation
plan: 04
type: execute
wave: 2
depends_on: [01-02]
files_modified: [main/ipc/database.js, main/ipc/handlers.js, main/index.js]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SQLite database initialized at userData path"
    - "IPC handlers registered for database operations"
    - "Sender validation prevents unauthorized access"
    - "Database schema created with annotations and documents tables"
  artifacts:
    - path: "main/ipc/database.js"
      provides: "SQLite database initialization and operations"
      min_lines: 30
      contains: ["Database", "better-sqlite3", "app.getPath('userData')"]
    - path: "main/ipc/handlers.js"
      provides: "IPC channel handlers for database operations"
      min_lines: 40
      contains: ["ipcMain.handle", "validateSender"]
    - path: "main/index.js"
      provides: "IPC handler registration"
      contains: ["registerHandlers"]
  key_links:
    - from: "main/ipc/handlers.js"
      to: "main/ipc/database.js"
      via: "Database operations"
      pattern: "db\\.prepare|db\\.exec"
    - from: "main/index.js"
      to: "main/ipc/handlers.js"
      via: "Import and execute registerHandlers"
      pattern: "require\\(['\"]\\.\\/ipc\\/handlers['\"]\\)"
---

<objective>
Create SQLite database layer and IPC handlers with sender validation for secure renderer-to-main communication.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-electron-foundation/01-RESEARCH.md
@.planning/phases/01-electron-foundation/01-03-SUMMARY.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Create SQLite database module</name>
  <files>main/ipc/database.js</files>
  <action>
    Create main/ipc/database.js with:
    - Import better-sqlite3 and electron app
    - Initialize Database at app.getPath('userData')/annotations.db
    - Create function initializeSchema():
      * Create annotations table if not exists:
        - id INTEGER PRIMARY KEY AUTOINCREMENT
        - type TEXT NOT NULL (for 'highlight' or 'note')
        - text TEXT NOT NULL
        - position TEXT NOT NULL (JSON string)
        - note TEXT (optional, for user's note)
        - created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      * Create documents table if not exists (for Phase 3):
        - id INTEGER PRIMARY KEY AUTOINCREMENT
        - filename TEXT NOT NULL
        - filepath TEXT NOT NULL
        - title TEXT
        - created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    - Export db instance and initializeSchema function

    Follow RESEARCH.md "Pattern 2: IPC Bridge for SQLite Access"
  </action>
  <verify>main/ipc/database.js exists with Database initialization and schema creation</verify>
  <done>SQLite database module created with annotations and documents tables</done>
</task>

<task type="auto">
  <name>Create IPC handlers with sender validation</name>
  <files>main/ipc/handlers.js</files>
  <action>
    Create main/ipc/handlers.js with:
    - Import ipcMain and app from electron
    - Import db from ./database.js
    - Create validateSender(frame) function:
      * Check frame.url against allowed origins
      * Allowed: app.getAppPath() (local files), http://localhost:3000 (dev server)
      * Return true if allowed, false otherwise
      * Log warning if unauthorized
    - Register IPC handlers:
      * 'db:exec': Execute SQL statement (INSERT, UPDATE, DELETE)
        - Validate sender
        - Run db.prepare(sql).run(params)
        - Return lastInsertRowid or changes
      * 'db:query': Execute SELECT query
        - Validate sender
        - Run db.prepare(sql).all(params)
        - Return results array
      * 'db:init': Initialize database schema
        - Call initializeSchema()
        - Return success message
    - Export registerHandlers function to call from main/index.js

    Follow RESEARCH.md "Secure IPC Pattern" and "Pattern 2: IPC Bridge"
  </action>
  <verify>main/ipc/handlers.js exists with validateSender and db:* IPC handlers</verify>
  <done>Secure IPC handlers created with sender validation</done>
</task>

<task type="auto">
  <name>Register IPC handlers in main process</name>
  <files>main/index.js</files>
  <action>
    Modify main/index.js:
    - Import registerHandlers from './ipc/handlers.js'
    - After app.whenReady(), call registerHandlers()
    - This sets up all IPC channels before window creation

    Ensure handlers are registered before any renderer loads.
  </action>
  <verify>main/index.js imports and calls registerHandlers()</verify>
  <done>IPC handlers registered at application startup</done>
</task>

</tasks>

<verification>
- Database initializes at userData path
- Schema contains annotations and documents tables
- IPC handlers validate sender before executing
- db:exec, db:query, db:init channels registered
- Handlers registered before window creation
</verification>

<success_criteria>
SQLite database layer with secure IPC handlers enabling renderer-to-main communication with sender validation.
</success_criteria>

<output>
After completion, create `.planning/phases/01-electron-foundation/01-04-SUMMARY.md`
</output>
