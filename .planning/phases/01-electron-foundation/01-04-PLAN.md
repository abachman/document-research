---
phase: 01-electron-foundation
plan: 04
type: execute
wave: 2
depends_on: [01-02]
files_modified: [electron/main/ipc/database.ts, electron/main/ipc/handlers.ts, electron/main/index.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SQLite database initialized at userData path"
    - "IPC handlers registered for database operations"
    - "Sender validation prevents unauthorized access"
    - "Database schema created with annotations and documents tables"
  artifacts:
    - path: "electron/main/ipc/database.ts"
      provides: "SQLite database initialization and operations"
      min_lines: 40
      contains: ["Database", "better-sqlite3", "app.getPath('userData')"]
    - path: "electron/main/ipc/handlers.ts"
      provides: "IPC channel handlers for database operations"
      min_lines: 50
      contains: ["ipcMain.handle", "validateSender"]
    - path: "electron/main/index.ts"
      provides: "IPC handler registration"
      contains: ["registerHandlers"]
  key_links:
    - from: "electron/main/ipc/handlers.ts"
      to: "electron/main/ipc/database.ts"
      via: "Database operations"
      pattern: "db\\.prepare|db\\.exec"
    - from: "electron/main/index.ts"
      to: "electron/main/ipc/handlers.ts"
      via: "Import and execute registerHandlers"
      pattern: "import.*registerHandlers|registerHandlers\\(\\)"
---

<objective>
Create SQLite database layer and IPC handlers with sender validation for secure renderer-to-main communication using TypeScript.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-electron-foundation/01-ELECTRON-VITE-RESEARCH.md
@.planning/phases/01-electron-foundation/01-03-SUMMARY.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Create SQLite database module</name>
  <files>electron/main/ipc/database.ts</files>
  <action>
    Create electron/main/ipc/database.ts with:
    - Import Database from 'better-sqlite3'
    - Import { app } from 'electron'
    - Import { join } from 'path'
    - Initialize Database at join(app.getPath('userData'), 'annotations.db')
    - Create function initializeSchema():
      * Create annotations table if not exists:
        - id INTEGER PRIMARY KEY AUTOINCREMENT
        - type TEXT NOT NULL (for 'highlight' or 'note')
        - text TEXT NOT NULL
        - position TEXT NOT NULL (JSON string)
        - note TEXT (optional, for user's note)
        - created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      * Create documents table if not exists (for Phase 3):
        - id INTEGER PRIMARY KEY AUTOINCREMENT
        - filename TEXT NOT NULL
        - filepath TEXT NOT NULL
        - title TEXT
        - created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    - Export db instance and initializeSchema function

    Use TypeScript (.ts file) and ESM imports.
    Follow RESEARCH.md code examples for better-sqlite3 usage
  </action>
  <verify>electron/main/ipc/database.ts exists with Database initialization and schema creation</verify>
  <done>SQLite database module created with annotations and documents tables</done>
</task>

<task type="auto">
  <name>Create IPC handlers with sender validation</name>
  <files>electron/main/ipc/handlers.ts</files>
  <action>
    Create electron/main/ipc/handlers.ts with:
    - Import ipcMain and app from 'electron'
    - Import db and initializeSchema from './database.js' (note: .js extension for ESM)
    - Create validateSender(frame) function:
      * Check frame.url against allowed origins
      * Allowed: join(app.getAppPath()) (local files), http://localhost:3000 (dev server)
      * Return true if allowed, false otherwise
      * Log warning if unauthorized
    - Create registerHandlers function:
      * 'db:exec': Execute SQL statement (INSERT, UPDATE, DELETE)
        - Validate sender
        - Run db.prepare(sql).run(params)
        - Return lastInsertRowid or changes
      * 'db:query': Execute SELECT query
        - Validate sender
        - Run db.prepare(sql).all(params)
        - Return results array
      * 'db:init': Initialize database schema
        - Call initializeSchema()
        - Return success message
    - Export registerHandlers function to call from electron/main/index.ts

    Use TypeScript (.ts file) and ESM imports.
    Follow RESEARCH.md "Pattern 4: IPC Handlers in Main Process"
  </action>
  <verify>electron/main/ipc/handlers.ts exists with validateSender and db:* IPC handlers</verify>
  <done>Secure IPC handlers created with sender validation</done>
</task>

<task type="auto">
  <name>Register IPC handlers in main process</name>
  <files>electron/main/index.ts</files>
  <action>
    Modify electron/main/index.ts:
    - Import registerHandlers from './ipc/handlers.js' (note: .js extension for ESM)
    - After app.whenReady(), call registerHandlers()
    - This sets up all IPC channels before window creation

    Ensure handlers are registered before any renderer loads.
    Use ESM import syntax.
  </action>
  <verify>electron/main/index.ts imports and calls registerHandlers()</verify>
  <done>IPC handlers registered at application startup</done>
</task>

</tasks>

<verification>
- Database initializes at userData path
- Schema contains annotations and documents tables
- IPC handlers validate sender before executing
- db:exec, db:query, db:init channels registered
- Handlers registered before window creation
- TypeScript and ESM imports used
</verification>

<success_criteria>
SQLite database layer with secure IPC handlers enabling renderer-to-main communication with sender validation, using TypeScript.
</success_criteria>

<output>
After completion, create `.planning/phases/01-electron-foundation/01-04-SUMMARY.md`
</output>
