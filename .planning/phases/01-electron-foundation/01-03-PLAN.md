---
phase: 01-electron-foundation
plan: 03
type: execute
wave: 2
depends_on: [01-02]
files_modified: [electron/main/index.ts, electron/preload/index.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Application launches as desktop window"
    - "Next.js frontend displays in desktop window"
    - "Development server loads in dev mode, production build in prod mode"
    - "Preload script uses contextBridge for secure API exposure"
    - "ESM imports used (import.meta.url not __dirname)"
  artifacts:
    - path: "electron/main/index.ts"
      provides: "Electron main process entry point"
      min_lines: 40
      contains: ["BrowserWindow", "app.whenReady", "import.meta.url"]
    - path: "electron/preload/index.ts"
      provides: "Preload script with contextBridge"
      min_lines: 20
      contains: ["contextBridge", "exposeInMainWorld"]
  key_links:
    - from: "electron/main/index.ts"
      to: "http://localhost:3000"
      via: "loadURL in development mode"
      pattern: "loadURL.*localhost:3000"
    - from: "electron/main/index.ts"
      to: "electron-serve"
      via: "appServe in production mode"
      pattern: "appServe|loadURL.*app://"
    - from: "electron/preload/index.ts"
      to: "renderer process"
      via: "contextBridge.exposeInMainWorld"
      pattern: "contextBridge\\.exposeInMainWorld"
---

<objective>
Create Electron main process and preload script with secure contextBridge pattern for Next.js integration using TypeScript and ESM.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-electron-foundation/01-ELECTRON-VITE-RESEARCH.md
@.planning/phases/01-electron-foundation/01-02-SUMMARY.md
@electron.vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Create Electron main process</name>
  <files>electron/main/index.ts</files>
  <action>
    Create electron/main/index.ts with:
    - Import from 'electron' and 'path'
    - Import { fileURLToPath } from 'url'
    - Import electronServe from 'electron-serve'
    - Create __dirname constant: `const __dirname = fileURLToPath(new URL('.', import.meta.url))`
    - Create appServe constant:
      * In production: electronServe({ directory: join(__dirname, '../renderer') }) or similar
      * In development: null (use localhost:3000)
    - createWindow function:
      * BrowserWindow with width 1200, height 800
      * webPreferences:
        - preload: join(__dirname, '../preload/index.js')
        - contextIsolation: true
        - nodeIntegration: false
        - sandbox: false (set to true for production security)
      * If app.isPackaged: use appServe(win) then win.loadURL('app://-')
      * If development: win.loadURL('http://localhost:3000')
      * win.webContents.openDevTools() in dev mode
      * Add did-fail-load handler to retry if Next.js not ready:
        ```typescript
        win.webContents.on('did-fail-load', () => {
          win.webContents.reloadIgnoringCache()
        })
        ```
    - app.whenReady().then(createWindow)
    - app.on('window-all-closed') with platform check (quit unless darwin)
    - app.on('activate') with window recreation if all closed (darwin)

    Use TypeScript (.ts file) and ESM imports (import, not require).
    Follow RESEARCH.md "Pattern 3: Main Process with Next.js Loading"
  </action>
  <verify>electron/main/index.ts exists with BrowserWindow, createWindow, ESM imports, dev/prod load logic</verify>
  <done>Electron main process created with Next.js loading logic using TypeScript</done>
</task>

<task type="auto">
  <name>Create preload script with contextBridge</name>
  <files>electron/preload/index.ts</files>
  <action>
    Create electron/preload/index.ts with:
    - Import contextBridge and ipcRenderer from electron
    - Use contextBridge.exposeInMainWorld to create 'electronAPI' object
    - For now, expose empty object (will add IPC methods in 01-05)
    - Use TypeScript syntax

    Follow RESEARCH.md security best practices:
    - contextIsolation: true (enforced by default)
    - Only expose specific APIs via contextBridge
    - Never expose raw ipcRenderer
  </action>
  <verify>electron/preload/index.ts exists with contextBridge.exposeInMainWorld('electronAPI', {})</verify>
  <done>Secure preload script created with contextBridge pattern using TypeScript</done>
</task>

</tasks>

<verification>
- Main process creates BrowserWindow with correct security settings
- Preload script uses contextBridge
- Development mode loads from localhost:3000
- Production mode uses electron-serve
- Window lifecycle managed correctly for platform
- ESM imports used (import.meta.url, not __dirname)
- did-fail-load handler handles Next.js dev server race condition
</verification>

<success_criteria>
Electron application launches as desktop window showing Next.js frontend with proper development/production loading logic using TypeScript and ESM.
</success_criteria>

<output>
After completion, create `.planning/phases/01-electron-foundation/01-03-SUMMARY.md`
</output>
