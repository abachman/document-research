---
phase: 02-python-ml-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - python-service/main.py
  - python-service/api/health.py
  - python-service/api/__init__.py
  - python-service/utils/port_utils.py
  - python-service/utils/__init__.py
  - python-service/config.py
  - python-service/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Python service starts and binds to an available port"
    - "Port number is written to file for Electron discovery"
    - "Health check endpoint responds with 200 OK"
    - "Python service can be started manually for testing"
  artifacts:
    - path: "python-service/main.py"
      provides: "FastAPI application entry point"
      min_lines: 30
    - path: "python-service/api/health.py"
      provides: "Health check endpoint"
      exports: ["GET /health"]
    - path: "python-service/requirements.txt"
      provides: "Python dependencies"
      contains: ["fastapi", "uvicorn"]
    - path: "python-service/utils/port_utils.py"
      provides: "Port discovery and file sync"
      exports: ["get_available_port", "write_port_file"]
  key_links:
    - from: "python-service/main.py"
      to: "python-service/utils/port_utils.py"
      via: "import statement"
      pattern: "from.*port_utils.*import|import.*port_utils"
    - from: "python-service/main.py"
      to: "/health endpoint"
      via: "FastAPI router"
      pattern: "@app\\.get.*health|app\\.include_router"
---

<objective>
Python HTTP API service with FastAPI that starts on an available port and exposes health check endpoints.

Purpose: Establish the foundation for the ML service that Electron will spawn and communicate with.
Output: Working FastAPI service that can be started manually and responds to health checks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-python-ml-service/02-CONTEXT.md
@.planning/phases/02-python-ml-service/02-RESEARCH.md

# Phase 1 Summary for context
@.planning/phases/01-electron-foundation/01-03-SUMMARY.md
@.planning/phases/01-electron-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python service structure and requirements</name>
  <files>
    python-service/main.py
    python-service/requirements.txt
    python-service/config.py
  </files>
  <action>
    Create python-service directory structure with:

    **python-service/requirements.txt:**
    ```
    fastapi==0.115.6
    uvicorn[standard]==0.32.1
    python-multipart==0.0.20
    ```

    **python-service/config.py:**
    - Define configuration class with host (127.0.0.1), port (dynamic), log level
    - Include constants for health check interval and max startup time

    **python-service/main.py:**
    - Import FastAPI, uvicorn, config, port_utils
    - Create FastAPI app instance with title "Document Research ML Service"
    - Define get_available_port() function that finds open port on 127.0.0.1
    - Define write_port_file(port, path) that writes port to temp directory
    - Port file location: Use platform-appropriate temp directory
      - macOS/Linux: /tmp/doc-research-ml-port.txt
      - Windows: %TEMP%\doc-research-ml-port.txt
    - In main block: Get available port, write to port file, start uvicorn
    - Set PYTHONUNBUFFERED=1 in environment for real-time logging

    Do NOT use hardcoded ports (must be dynamic for conflict avoidance).
  </action>
  <verify>
    Run: `cd python-service && python3 main.py` (should start without errors)
    Check: Port file created in temp directory
    Verify: Process logs show "Uvicorn running on http://127.0.0.1:XXXXX"
  </verify>
  <done>
    Python service starts on available port, writes port to file, uvicorn logs confirm binding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health check API endpoint</name>
  <files>
    python-service/api/health.py
    python-service/api/__init__.py
    python-service/utils/port_utils.py
    python-service/utils/__init__.py
  </files>
  <action>
    Create health check endpoint structure:

    **python-service/utils/__init__.py:**
    - Empty init file for package

    **python-service/utils/port_utils.py:**
    - Move port discovery functions from main.py:
      - get_available_port(): Uses socket to find free port on 127.0.0.1
      - write_port_file(port, path): Writes port string to file, creates parent dirs
    - Add get_port_file_path() function that returns platform-appropriate path
    - Use pathlib.Path for cross-platform path handling

    **python-service/api/__init__.py:**
    - Empty init file for api package

    **python-service/api/health.py:**
    - Create FastAPI router for health endpoints
    - Implement GET /health endpoint returning:
      ```json
      {
        "status": "ok",
        "service": "document-research-ml",
        "version": "0.1.0"
      }
      ```
    - Return HTTP 200 with JSON response

    **Update python-service/main.py:**
    - Import health router: `from api.health import router as health_router`
    - Include router: `app.include_router(health_router, tags=["health"])`
    - Move port utils imports to use new module

    Do NOT expose /docs or /openapi.json in production (security).
  </action>
  <verify>
    Start service: `cd python-service && python3 main.py`
    Test: `curl http://127.0.0.1:$(cat /tmp/doc-research-ml-port.txt)/health`
    Verify: Returns 200 status with JSON containing "status": "ok"
  </verify>
  <done>
    Health check endpoint accessible via curl, returns expected JSON structure.
  </done>
</task>

</tasks>

<verification>
1. Python service starts manually from command line
2. Port file is created in temp directory with valid port number
3. Health check endpoint returns 200 OK with service status
4. Service logs show uvicorn binding to 127.0.0.1 with dynamic port
5. Clean shutdown with Ctrl+C terminates process cleanly
</verification>

<success_criteria>
Python HTTP API foundation is ready for:
- PDF upload endpoint integration (Plan 02-02)
- ChromaDB service addition (Plan 02-03)
- Electron process spawning (Plan 02-04)
</success_criteria>

<output>
After completion, create `.planning/phases/02-python-ml-service/02-01-SUMMARY.md`
</output>
